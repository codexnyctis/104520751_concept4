<template>
  <div class="bg-white dark:bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-lg shadow p-4 h-full flex flex-col">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold text-purple-800 dark:text-purple-100">Malware Family Distribution</h2>
      <div class="relative">
        <select v-model="selectedCategory" class="block appearance-none w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 py-1 px-2 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-purple-500 text-sm">
          <option value="">All Categories</option>
          <option v-for="category in categories" :key="category" :value="category">{{ category }}</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
          <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
        </div>
      </div>
    </div>
    <div class="flex-grow">
      <Bar v-if="chartData.labels.length > 0" :data="chartData" :options="chartOptions" />
      <p v-else class="text-center text-gray-500 dark:text-gray-400">No data available</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { Bar } from 'vue-chartjs'
import { Chart as ChartJS, CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend } from 'chart.js'

ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend)

const lightLilac = 'rgba(230, 210, 255, 0.8)'
const darkPurpleBorder = 'rgba(75, 0, 130, 1)'

const props = defineProps(['results'])

const selectedCategory = ref('')

const malwareCategoryMap = {
  'Trojan Horse': ['Zeus', 'Emotet', 'Refroso', 'scar', 'Reconyc'],
  'Spyware': ['180Solutions', 'CoolWebSearch', 'Gator', 'Transponder', 'TIBS'],
  'Ransomware': ['Conti', 'MAZE', 'Pysa', 'Ako', 'Shade'],
  'Benign': ['Benign']
}

const malwareInfo = {
  'Zeus': 'A sophisticated Trojan horse malware that targets banking information, often using man-in-the-browser tactics to steal credentials.',
  'Emotet': 'A highly persistent and modular banking Trojan that also functions as a distributor for other malware. Known for its rapid evolution and evasion techniques.',
  'Refroso': 'A Trojan that can download and execute additional malicious files, often used as part of a larger malware campaign.',
  'scar': 'A Trojan that provides unauthorized remote access to infected computers, allowing attackers to control the system and steal sensitive information.',
  'Reconyc': 'A Trojan that specializes in downloading and installing additional malware, often used as the first stage in multi-layered attacks.',
  '180Solutions': 'Adware that displays targeted pop-up advertisements based on users\' browsing habits, often bundled with free software.',
  'CoolWebSearch': 'An aggressive spyware that hijacks browsers, changes settings, and tracks user activity. Notoriously difficult to remove completely.',
  'Gator': 'Adware that tracks users\' online activities to serve targeted advertisements, often installed bundled with free software.',
  'Transponder': 'Spyware that monitors users\' computer activities, potentially capturing keystrokes, screenshots, and other sensitive data.',
  'TIBS': 'A spyware program that collects personal information, including browsing habits and potentially sensitive data like passwords.',
  'Conti': 'A sophisticated ransomware strain known for targeting large organizations, using double extortion tactics by both encrypting and stealing data.',
  'MAZE': 'Ransomware that not only encrypts files but also exfiltrates data, threatening to publish stolen information if the ransom isn\'t paid.',
  'Pysa': 'A ransomware variant that specifically targets large organizations and government entities, known for its data exfiltration capabilities.',
  'Ako': 'A ransomware that encrypts files and demands payment for decryption, often distributed through phishing emails or exploit kits.',
  'Shade': 'Also known as Troldesh, this ransomware encrypts files and demands payment in cryptocurrency, known for changing tactics over time.',
  'Benign': 'Clean or legitimate software with no malicious intent. These files are safe for use and do not pose a security threat.'
}

const categories = computed(() => [''].concat([...new Set(Object.keys(malwareCategoryMap))]))

const getFamilyCategory = (family) => {
  for (const [category, families] of Object.entries(malwareCategoryMap)) {
    if (families.includes(family)) {
      return category
    }
  }
  return 'Unknown'
}

const chartData = computed(() => {
  let data = props.results
  if (selectedCategory.value) {
    data = data.filter(r => getFamilyCategory(r['Predicted Class']) === selectedCategory.value)
  }
  return {
    labels: data.map(r => r['Predicted Class']),
    datasets: [{
      label: 'Confidence',
      data: data.map(r => r.Confidence),
      backgroundColor: lightLilac,
      borderColor: darkPurpleBorder,
      borderWidth: 2
    }]
  }
})

const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  indexAxis: 'y',
  scales: {
    x: {
      beginAtZero: true,
      max: 1,
      ticks: {
        callback: function(value) {
          return (value * 100).toFixed(0) + '%';
        },
        color: 'rgba(255, 255, 255, 0.9)',
        font: {
          size: 12,
          family: 'Arial, sans-serif'
        }
      },
      grid: {
        color: 'rgba(255, 255, 255, 0.2)',
        lineWidth: 1
      }
    },
    y: {
      ticks: {
        color: 'rgba(255, 255, 255, 0.9)',
        font: {
          size: 12,
          family: 'Arial, sans-serif'
        }
      },
      grid: {
        color: 'rgba(255, 255, 255, 0.1)',
        display: true
      }
    }
  },
  plugins: {
    legend: {
      display: false,
    },
    tooltip: {
      backgroundColor: 'rgba(255, 255, 255, 0.8)',
      titleColor: 'rgba(0, 0, 0, 0.9)',
      bodyColor: 'rgba(0, 0, 0, 0.9)',
      callbacks: {
        title: function(context) {
          return context[0].label;
        },
        label: function(context) {
          const family = context.label;
          const category = getFamilyCategory(family);
          const confidence = (context.parsed.x * 100).toFixed(2);
          const info = malwareInfo[family] || 'No additional information available.';
          return [
            `Category: ${category}`,
            `Confidence: ${confidence}%`,
            `Info: ${info}`
          ];
        }
      }
    }
  }
}

watch(() => props.results, () => {
  selectedCategory.value = ''
})
</script>