<template>
  <div class="bg-white dark:bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-lg shadow p-4 h-full flex flex-col">
    <h2 class="text-lg font-semibold mb-2 text-purple-800 dark:text-purple-100">Malware Category Distribution</h2>
    <div class="flex-grow">
      <Pie v-if="chartData.labels.length > 0" :data="chartData" :options="chartOptions" />
      <p v-else class="text-center text-gray-500 dark:text-gray-400">No data available</p>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { Pie } from 'vue-chartjs'
import { Chart as ChartJS, ArcElement, Tooltip, Legend } from 'chart.js'

ChartJS.register(ArcElement, Tooltip, Legend)

const props = defineProps(['distribution'])

const malwareCategoryMap = {
  'Zeus': 'Trojan Horse',
  'Emotet': 'Trojan Horse',
  'Refroso': 'Trojan Horse',
  'Scar': 'Trojan Horse',
  'Reconyc': 'Trojan Horse',
  '180Solutions': 'Spyware',
  'CWS': 'Spyware',
  'Gator': 'Spyware',
  'Transponder': 'Spyware',
  'TIBS': 'Spyware',
  'Conti': 'Ransomware',
  'MAZE': 'Ransomware',
  'Pysa': 'Ransomware',
  'Ako': 'Ransomware',
  'Shade': 'Ransomware',
  'Benign': 'Benign'
}

const chartData = computed(() => {
  const categoryDistribution = Object.entries(props.distribution).reduce((acc, [family, count]) => {
    const category = malwareCategoryMap[family] || 'Unknown'
    acc[category] = (acc[category] || 0) + count
    return acc
  }, {})

  return {
    labels: Object.keys(categoryDistribution),
    datasets: [{
      data: Object.values(categoryDistribution),
      backgroundColor: [
        'rgba(255, 99, 132, 0.6)',  // Red for Trojan Horse
        'rgba(54, 162, 235, 0.6)',  // Blue for Spyware
        'rgba(255, 206, 86, 0.6)',  // Yellow for Ransomware
        'rgba(75, 192, 192, 0.6)',  // Green for Benign
        'rgba(153, 102, 255, 0.6)'  // Purple for Unknown (if any)
      ],
      borderColor: 'rgba(255, 255, 255, 0.5)',
      borderWidth: 1
    }]
  }
})

const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      position: 'bottom',
      labels: {
        color: 'rgb(229, 231, 235)',
        font: {
          size: 12
        },
        boxWidth: 15,
        padding: 10
      }
    },
    tooltip: {
      callbacks: {
        label: function(context) {
          const label = context.label || '';
          const value = context.raw || 0;
          const total = context.dataset.data.reduce((acc, cur) => acc + cur, 0);
          const percentage = ((value / total) * 100).toFixed(1);
          return `${label}: ${value} (${percentage}%)`;
        }
      }
    }
  }
}
</script>